---
// MD3 Theme Color Picker Component
---

<button
  class="color-picker-trigger md-icon-button text-[var(--color-md-on-surface-variant)]"
  aria-label="选择主题颜色"
  id="color-picker-trigger"
>
  <span class="material-symbols-outlined" id="color-picker-icon">palette</span>
</button>

<div class="color-picker-dropdown hidden" id="color-picker-dropdown">
  <div class="color-picker-header">
    <span class="title-small">主题颜色</span>
    <button class="color-picker-close md-icon-button" aria-label="关闭" id="color-picker-close">
      <span class="material-symbols-outlined">close</span>
    </button>
  </div>

  <div class="color-picker-presets">
    <p class="label-medium preset-label">预设颜色</p>
    <div class="preset-colors">
      <button class="preset-color" data-color="#0066CC" style="background-color: #0066CC" aria-label="蓝色"></button>
      <button class="preset-color" data-color="#6750A4" style="background-color: #6750A4" aria-label="紫色"></button>
      <button class="preset-color" data-color="#7D5260" style="background-color: #7D5260" aria-label="粉红"></button>
      <button class="preset-color" data-color="#006D3B" style="background-color: #006D3B" aria-label="绿色"></button>
      <button class="preset-color" data-color="#0054A5" style="background-color: #0054A5" aria-label="深蓝"></button>
      <button class="preset-color" data-color="#BE4D25" style="background-color: #BE4D25" aria-label="橙色"></button>
      <button class="preset-color" data-color="#9C27B0" style="background-color: #9C27B0" aria-label="紫红"></button>
      <button class="preset-color" data-color="#00796B" style="background-color: #00796B" aria-label="青绿"></button>
    </div>
  </div>

  <div class="color-picker-custom">
    <p class="label-medium custom-label">自定义颜色</p>
    <div class="custom-color-wrapper">
      <input type="color" id="custom-color-input" value="#0066CC" class="custom-color-input" />
      <span class="custom-color-hex" id="custom-color-hex">#0066CC</span>
    </div>
  </div>
</div>

<style>
  .color-picker-trigger {
    position: relative;
  }

  .color-picker-trigger .material-symbols-outlined {
    transition: transform 0.2s ease;
  }

  .color-picker-trigger:hover .material-symbols-outlined {
    transform: scale(1.1);
  }

  .color-picker-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 1rem;
    width: 280px;
    background: var(--color-md-surface);
    border-radius: 1rem;
    box-shadow:
      0 8px 30px rgba(0, 0, 0, 0.12),
      0 4px 12px rgba(0, 0, 0, 0.08),
      0 0 0 1px rgba(0, 0, 0, 0.05);
    padding: 1rem;
    z-index: 100;
    animation: slideIn 0.2s cubic-bezier(0.2, 0, 0, 1);
  }

  .color-picker-dropdown:not(.hidden) {
    display: block;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(-10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .color-picker-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-md-outline-variant);
  }

  .color-picker-close {
    width: 32px;
    height: 32px;
    color: var(--color-md-on-surface-variant);
  }

  .preset-label,
  .custom-label {
    color: var(--color-md-on-surface-variant);
    margin-bottom: 0.75rem;
  }

  .color-picker-presets {
    margin-bottom: 1.25rem;
  }

  .preset-colors {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
  }

  .preset-color {
    width: 100%;
    aspect-ratio: 1;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }

  .preset-color:hover {
    transform: scale(1.1);
  }

  .preset-color.selected {
    border-color: var(--color-md-primary);
  }

  .preset-color.selected::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 14px;
    font-weight: bold;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }

  .custom-color-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .custom-color-input {
    width: 48px;
    height: 48px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    padding: 0;
    overflow: hidden;
  }

  .custom-color-input::-webkit-color-swatch-wrapper {
    padding: 0;
  }

  .custom-color-input::-webkit-color-swatch {
    border: none;
    border-radius: 50%;
  }

  .custom-color-hex {
    font-family: 'MapleMono-NF-CN', monospace;
    font-size: 0.875rem;
    color: var(--color-md-on-surface);
    text-transform: uppercase;
  }
</style>

<script>
  import {
    themeFromSourceColor,
    applyTheme,
    argbFromHex,
  } from '@material/material-color-utilities';

  const colorPickerTrigger = document.getElementById('color-picker-trigger');
  const colorPickerDropdown = document.getElementById('color-picker-dropdown');
  const colorPickerClose = document.getElementById('color-picker-close');
  const presetColors = document.querySelectorAll('.preset-color');
  const customColorInput = document.getElementById('custom-color-input') as HTMLInputElement;
  const customColorHex = document.getElementById('custom-color-hex');

  // Get saved color or use default
  function getSavedColor(): string {
    if (typeof localStorage !== 'undefined') {
      return localStorage.getItem('md3-primary-color') || '#0066CC';
    }
    return '#0066CC';
  }

  // Save color to localStorage
  function saveColor(color: string) {
    if (typeof localStorage !== 'undefined') {
      localStorage.setItem('md3-primary-color', color);
    }
  }

  // Convert ARGB to RGB string
  function argbToRgb(argb: number): string {
    const r = (argb >> 16) & 255;
    const g = (argb >> 8) & 255;
    const b = argb & 255;
    return `${r}, ${g}, ${b}`;
  }

  // Apply theme to DOM
  function applyThemeColor(hexColor: string) {
    const isDark = document.documentElement.classList.contains('dark');
    const sourceColor = argbFromHex(hexColor);
    const theme = themeFromSourceColor(sourceColor);

    // Apply theme using material-color-utilities
    applyTheme(theme, { target: document.body, dark: isDark });

    // Get the scheme for current mode
    const scheme = isDark ? theme.schemes.dark : theme.schemes.light;
    const schemeObj = scheme as unknown as Record<string, number>;

    // Set CSS variables on root
    const root = document.documentElement;

    // Map all scheme colors to CSS variables
    const colorMappings: [string, string][] = [
      ['primary', 'primary'],
      ['onPrimary', 'on-primary'],
      ['primaryContainer', 'primary-container'],
      ['onPrimaryContainer', 'on-primary-container'],
      ['secondary', 'secondary'],
      ['onSecondary', 'on-secondary'],
      ['secondaryContainer', 'secondary-container'],
      ['onSecondaryContainer', 'on-secondary-container'],
      ['tertiary', 'tertiary'],
      ['onTertiary', 'on-tertiary'],
      ['tertiaryContainer', 'tertiary-container'],
      ['onTertiaryContainer', 'on-tertiary-container'],
      ['error', 'error'],
      ['onError', 'on-error'],
      ['errorContainer', 'error-container'],
      ['onErrorContainer', 'on-error-container'],
      ['surface', 'surface'],
      ['onSurface', 'on-surface'],
      ['surfaceVariant', 'surface-variant'],
      ['onSurfaceVariant', 'on-surface-variant'],
      ['surfaceTint', 'surface-tint'],
      ['background', 'background'],
      ['onBackground', 'on-background'],
      ['outline', 'outline'],
      ['outlineVariant', 'outline-variant'],
      ['inverseSurface', 'inverse-surface'],
      ['inverseOnSurface', 'inverse-on-surface'],
      ['inversePrimary', 'inverse-primary'],
    ];

    colorMappings.forEach(([schemeKey, varName]) => {
      const value = schemeObj[schemeKey];
      if (typeof value === 'number') {
        root.style.setProperty(`--md-sys-color-${varName}`, argbToRgb(value));
      }
    });

    // Update source color
    root.style.setProperty('--md-source-color', argbToRgb(sourceColor));

    // Update favicon color hint
    const metaThemeColor = document.querySelector('meta[name="theme-color"]');
    if (metaThemeColor) {
      const primaryArgb = schemeObj.primary;
      const r = (primaryArgb >> 16) & 255;
      const g = (primaryArgb >> 8) & 255;
      const b = primaryArgb & 255;
      metaThemeColor.setAttribute('content', `rgb(${r}, ${g}, ${b})`);
    }

    saveColor(hexColor);
  }

  // Update preset color selection UI
  function updatePresetSelection(selectedColor: string) {
    presetColors.forEach((btn) => {
      const btnColor = btn.getAttribute('data-color');
      if (btnColor === selectedColor) {
        btn.classList.add('selected');
      } else {
        btn.classList.remove('selected');
      }
    });
  }

  // Toggle dropdown
  function toggleDropdown() {
    colorPickerDropdown?.classList.toggle('hidden');
    if (!colorPickerDropdown?.classList.contains('hidden')) {
      const currentColor = getSavedColor();
      updatePresetSelection(currentColor);
      customColorInput.value = currentColor;
      if (customColorHex) {
        customColorHex.textContent = currentColor.toUpperCase();
      }
    }
  }

  function closeDropdown() {
    colorPickerDropdown?.classList.add('hidden');
  }

  // Event listeners
  colorPickerTrigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleDropdown();
  });

  colorPickerClose?.addEventListener('click', closeDropdown);

  presetColors.forEach((btn) => {
    btn.addEventListener('click', () => {
      const color = btn.getAttribute('data-color');
      if (color) {
        applyThemeColor(color);
        updatePresetSelection(color);
        customColorInput.value = color;
        if (customColorHex) {
          customColorHex.textContent = color.toUpperCase();
        }
      }
    });
  });

  // Custom color input - use both input and change events for better compatibility
  customColorInput?.addEventListener('input', () => {
    const color = customColorInput.value;
    if (customColorHex) {
      customColorHex.textContent = color.toUpperCase();
    }
    applyThemeColor(color);
    // Remove preset selection for custom colors
    presetColors.forEach(btn => btn.classList.remove('selected'));
  });

  customColorInput?.addEventListener('change', () => {
    // Finalize on change
    const color = customColorInput.value;
    applyThemeColor(color);
  });

  // Close on click outside
  document.addEventListener('click', (e) => {
    if (colorPickerDropdown && !colorPickerDropdown.contains(e.target as Node)) {
      closeDropdown();
    }
  });

  // Close on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeDropdown();
    }
  });

  // Listen for theme toggle changes
  function handleThemeChange() {
    const savedColor = getSavedColor();
    applyThemeColor(savedColor);
  }

  // Observe html element class changes for dark mode toggle
  const themeObserver = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const savedColor = getSavedColor();
        applyThemeColor(savedColor);
      }
    });
  });

  themeObserver.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class'],
  });

  // Also listen for theme toggle button clicks
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.closest('#theme-toggle') || target.closest('.theme-toggle')) {
      setTimeout(handleThemeChange, 100);
    }
  });

  // Initialize with saved color on page load
  function init() {
    const savedColor = getSavedColor();
    applyThemeColor(savedColor);
    updatePresetSelection(savedColor);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
