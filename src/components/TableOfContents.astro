---
interface Heading {
  id: string;
  text: string;
  level: number;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;
---

{headings.length > 0 && (
  <>
    {/* Mobile TOC Overlay */}
    <div
      id="toc-overlay"
      class="fixed inset-0 z-50 bg-black/50 hidden"
    >
      <div class="absolute right-0 top-16 bottom-0 w-72 max-w-[85vw] bg-[var(--color-md-surface)] shadow-xl">
        <div class="sticky top-0 bg-[var(--color-md-surface)] z-10 p-4 border-b border-[var(--color-md-outline-variant)] flex items-center justify-between">
          <h3 class="title-medium text-[var(--color-md-on-surface)] flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">list</span>
            目录
          </h3>
          <button
            id="toc-close"
            class="p-2 rounded-full hover:bg-[var(--color-md-surface-variant)] transition-colors"
            aria-label="关闭目录"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <nav class="overflow-y-auto max-h-[calc(100vh-100px)] p-4">
          <ul class="space-y-1">
            {headings.map((heading) => (
              <li>
                <button
                  class="toc-link w-full text-left py-2 px-3 rounded-lg transition-colors text-sm hover:bg-[var(--color-md-surface-variant)]"
                  data-target={heading.id}
                  style={`padding-left: ${(heading.level - 1) * 12 + 12}px`}
                >
                  {heading.text}
                </button>
              </li>
            ))}
          </ul>
        </nav>
      </div>
    </div>

    {/* Desktop TOC Sidebar - Show only when there's enough space */}
    <aside id="toc-sidebar" class="hidden fixed right-6 top-32 w-56 z-30">
      <div class="bg-[var(--color-md-surface)] rounded-xl border border-[var(--color-md-outline-variant)] shadow-sm overflow-hidden max-h-[calc(100vh-160px)] flex flex-col">
        <div class="p-3 border-b border-[var(--color-md-outline-variant)] flex-shrink-0">
          <h3 class="title-small text-[var(--color-md-on-surface)] flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">list</span>
            目录
          </h3>
        </div>
        <nav class="overflow-y-auto flex-1 p-2">
          <ul class="space-y-0.5">
            {headings.map((heading) => (
              <li>
                <button
                  class="toc-link w-full text-left py-1.5 px-3 rounded-lg transition-all duration-200 text-xs hover:bg-[var(--color-md-surface-variant)]"
                  data-target={heading.id}
                  style={`padding-left: ${(heading.level - 1) * 12 + 12}px`}
                >
                  {heading.text}
                </button>
              </li>
            ))}
          </ul>
        </nav>
      </div>
    </aside>

    {/* TOC FAB - Show when sidebar is hidden */}
    <button
      id="toc-fab"
      class="fixed z-40 bottom-6 right-6 w-14 h-14 rounded-full bg-[var(--color-md-primary)] text-[var(--color-md-on-primary)] shadow-lg flex items-center justify-center hover:bg-[var(--color-md-primary-container)] hover:text-[var(--color-md-on-primary-container)] transition-colors toc-fab-visible"
      aria-label="显示目录"
    >
      <span class="material-symbols-outlined">list</span>
    </button>

    <script>
      (function() {
        const overlay = document.getElementById('toc-overlay');
        const sidebar = document.getElementById('toc-sidebar');
        const fab = document.getElementById('toc-fab');
        const closeBtn = document.getElementById('toc-close');
        const tocLinks = document.querySelectorAll('.toc-link');
        const backToTop = document.getElementById('back-to-top');

        function openOverlay() {
          overlay?.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }

        function closeOverlay() {
          overlay?.classList.add('hidden');
          document.body.style.overflow = '';
        }

        // FAB click - open overlay
        fab?.addEventListener('click', openOverlay);

        // Close button click
        closeBtn?.addEventListener('click', closeOverlay);

        // Click outside to close
        overlay?.addEventListener('click', (e) => {
          if (e.target === overlay) {
            closeOverlay();
          }
        });

        // Close on escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !overlay?.classList.contains('hidden')) {
            closeOverlay();
          }
        });

        // Smooth scroll to section
        tocLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('data-target');
            if (targetId) {
              const target = document.getElementById(targetId);
              if (target) {
                const offset = 80;
                const elementPosition = target.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.scrollY - offset;
                window.scrollTo({
                  top: offsetPosition,
                  behavior: 'smooth'
                });
                closeOverlay();
              }
            }
          });
        });

        // Scroll spy - highlight active heading
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const id = entry.target.id;
              tocLinks.forEach(link => {
                if (link.getAttribute('data-target') === id) {
                  link.classList.add('bg-[var(--color-md-primary-container)]', 'text-[var(--color-md-on-primary-container)]', 'font-medium');
                  link.classList.remove('text-[var(--color-md-on-surface-variant)]');
                } else {
                  link.classList.remove('bg-[var(--color-md-primary-container)]', 'text-[var(--color-md-on-primary-container)]', 'font-medium');
                  link.classList.add('text-[var(--color-md-on-surface-variant)]');
                }
              });
            }
          });
        }, {
          rootMargin: '-80px 0px -80% 0px',
          threshold: 0
        });

        // Observe headings
        tocLinks.forEach(link => {
          const targetId = link.getAttribute('data-target');
          if (targetId) {
            const target = document.getElementById(targetId);
            if (target) observer.observe(target);
          }
        });

        // Check if sidebar can be shown
        function checkSidebar() {
          if (!sidebar || !fab) return;
          
          const article = document.querySelector('article .max-w-3xl');
          if (!article) return;
          
          const articleRect = article.getBoundingClientRect();
          const availableWidth = window.innerWidth - articleRect.right - 24;
          
          // Show sidebar if article doesn't span full width AND there's enough space
          const canShowSidebar = articleRect.right < window.innerWidth - 100 && availableWidth >= 240;
          
          if (canShowSidebar) {
            sidebar.style.display = 'block';
            fab.classList.remove('toc-fab-visible');
          } else {
            sidebar.style.display = 'none';
            fab.classList.add('toc-fab-visible');
          }
        }

        // Initial check
        checkSidebar();

        // Recheck on resize
        window.addEventListener('resize', checkSidebar);

        // Recheck on scroll
        window.addEventListener('scroll', () => {
          requestAnimationFrame(checkSidebar);
        }, { passive: true });
      })();
    </script>
  </>
)}
