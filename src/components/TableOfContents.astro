---
interface Heading {
  id: string;
  text: string;
  level: number;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;
---

{headings.length > 0 && (
  <>
    {/* Mobile TOC Button */}
    <button
      id="toc-mobile-toggle"
      class="fixed bottom-6 right-6 z-40 md:hidden w-12 h-12 rounded-full bg-[var(--color-md-primary)] text-[var(--color-md-on-primary)] shadow-lg flex items-center justify-center hover:bg-[var(--color-md-primary-container)] hover:text-[var(--color-md-on-primary-container)] transition-colors"
      aria-label="显示目录"
    >
      <span class="material-symbols-outlined">list</span>
    </button>

    {/* Mobile TOC Overlay */}
    <div
      id="toc-mobile-overlay"
      class="fixed inset-0 z-50 bg-black/50 md:hidden hidden"
    >
      <div class="absolute right-0 top-0 bottom-0 w-72 max-w-[85vw] bg-[var(--color-md-surface)] shadow-xl overflow-y-auto">
        <div class="sticky top-0 bg-[var(--color-md-surface)] z-10 p-4 border-b border-[var(--color-md-outline-variant)] flex items-center justify-between">
          <h3 class="title-medium text-[var(--color-md-on-surface)] flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">list</span>
            目录
          </h3>
          <button
            id="toc-mobile-close"
            class="p-2 rounded-full hover:bg-[var(--color-md-surface-variant)] transition-colors"
            aria-label="关闭目录"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <nav class="p-4">
          <ul class="space-y-1">
            {headings.map((heading) => (
              <li>
                <button
                  class="toc-link w-full text-left py-2 px-3 rounded-lg transition-colors text-sm hover:bg-[var(--color-md-surface-variant)]"
                  data-target={heading.id}
                  style={`padding-left: ${(heading.level - 1) * 12 + 12}px`}
                >
                  {heading.text}
                </button>
              </li>
            ))}
          </ul>
        </nav>
      </div>
    </div>

    {/* Desktop TOC Sidebar - Show only when there's enough space */}
    <aside class="hidden fixed right-6 top-32 w-56 z-30" style="display: none;">
      <div class="bg-[var(--color-md-surface)] rounded-xl border border-[var(--color-md-outline-variant)] shadow-sm overflow-hidden max-h-[65vh]">
        <div class="p-3 border-b border-[var(--color-md-outline-variant)]">
          <h3 class="title-small text-[var(--color-md-on-surface)] flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">list</span>
            目录
          </h3>
        </div>
        <nav class="overflow-y-auto p-2">
          <ul class="space-y-0.5">
            {headings.map((heading) => (
              <li>
                <button
                  class="toc-link w-full text-left py-1.5 px-3 rounded-lg transition-all duration-200 text-xs hover:bg-[var(--color-md-surface-variant)]"
                  data-target={heading.id}
                  style={`padding-left: ${(heading.level - 1) * 12 + 12}px`}
                >
                  {heading.text}
                </button>
              </li>
            ))}
          </ul>
        </nav>
      </div>
    </aside>

    <style>
      /* Show TOC only when there's enough horizontal space */
      @media (min-width: 1280px) {
        aside[style*="display: none;"]:not([style*="display: none !important"]) {
          display: block !important;
        }
      }
    </style>

    <script>
      // TOC functionality
      (function() {
        const mobileToggle = document.getElementById('toc-mobile-toggle');
        const mobileOverlay = document.getElementById('toc-mobile-overlay');
        const mobileClose = document.getElementById('toc-mobile-close');
        const tocLinks = document.querySelectorAll('.toc-link');

        // Mobile toggle
        if (mobileToggle && mobileOverlay) {
          mobileToggle.addEventListener('click', () => {
            mobileOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
          });

          if (mobileClose) {
            mobileClose.addEventListener('click', () => {
              mobileOverlay.classList.add('hidden');
              document.body.style.overflow = '';
            });
          }

          mobileOverlay.addEventListener('click', (e) => {
            if (e.target === mobileOverlay) {
              mobileOverlay.classList.add('hidden');
              document.body.style.overflow = '';
            }
          });
        }

        // Smooth scroll to section
        tocLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('data-target');
            const target = document.getElementById(targetId);
            if (target) {
              const offset = 80;
              const elementPosition = target.getBoundingClientRect().top;
              const offsetPosition = elementPosition + window.scrollY - offset;
              window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
              });
              // Close mobile overlay if open
              if (mobileOverlay) {
                mobileOverlay.classList.add('hidden');
                document.body.style.overflow = '';
              }
            }
          });
        });

        // Scroll spy - highlight active heading
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const id = entry.target.id;
              tocLinks.forEach(link => {
                if (link.getAttribute('data-target') === id) {
                  link.classList.add('bg-[var(--color-md-primary-container)]', 'text-[var(--color-md-on-primary-container)]', 'font-medium');
                  link.classList.remove('text-[var(--color-md-on-surface-variant)]');
                } else {
                  link.classList.remove('bg-[var(--color-md-primary-container)]', 'text-[var(--color-md-on-primary-container)]', 'font-medium');
                  link.classList.add('text-[var(--color-md-on-surface-variant)]');
                }
              });
            }
          });
        }, {
          rootMargin: '-80px 0px -80% 0px',
          threshold: 0
        });

        // Observe all headings
        tocLinks.forEach(link => {
          const targetId = link.getAttribute('data-target');
          const target = document.getElementById(targetId);
          if (target) {
            observer.observe(target);
          }
        });
      })();
    </script>
  </>
)}
