---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { NavbarComponent } from '../components/angular/navbar.component';
import { FooterComponent } from '../components/angular/footer.component';
import { HeroSectionComponent } from '../components/angular/hero-section.component';
import { CategoriesSectionComponent } from '../components/angular/categories-section.component';
import { StatsSectionComponent } from '../components/angular/stats-section.component';

// Get all blog posts
const allPosts: CollectionEntry<'blog'>[] = await getCollection('blog');

// Sort posts by date (newest first)
const sortedPosts: CollectionEntry<'blog'>[] = allPosts.sort(
  (a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => b.data.date.getTime() - a.data.date.getTime()
);

// Get latest post
const latestPost = sortedPosts[0];

// Prepare latest post data for Angular component
const latestPostData = latestPost ? {
  slug: latestPost.slug,
  title: latestPost.data.title,
  description: latestPost.data.description,
  category: latestPost.data.category
} : null;

// Get unique categories with post count
const categoriesData = [...new Set(allPosts.map((post: CollectionEntry<'blog'>) => post.data.category))].map((category: string) => {
  const count = allPosts.filter((p: CollectionEntry<'blog'>) => p.data.category === category).length;
  return { name: category, count };
});

// Prepare stats data
const statsData = [
  { icon: 'article', value: String(allPosts.length), label: '文章总数' },
  { icon: 'category', value: String(categoriesData.length), label: '分类数量' },
  { icon: 'code', value: '100%', label: '由 AI 辅助' }
];
---

<BaseLayout title="欢迎 - My Blog">
  <NavbarComponent active="welcome" client:load />

  <main class="welcome-page">
    <HeroSectionComponent latestPost={latestPostData} client:load />
    <CategoriesSectionComponent categories={categoriesData} client:load />
    <StatsSectionComponent stats={statsData} client:load />
  </main>

  <FooterComponent client:load />
</BaseLayout>

<style>
  .welcome-page {
    flex: 1;
  }
</style>

