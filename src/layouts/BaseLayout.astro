---
import '../styles/global.css';
import BackToTop from '../components/BackToTop.astro';

interface Props {
  title: string;
  description?: string;
  image?: string;
}

const { title, description = '一个 Material Design 3 风格的现代化博客', image = '/og-image.png' } = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <title>{title}</title>
    <meta name="description" content={description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.url)} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.url)} />

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#0066cc" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="My Blog" />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'WebSite',
      name: 'My Blog',
      url: Astro.site,
      description: '一个 Material Design 3 风格的现代化博客',
      inLanguage: 'zh-CN',
      potentialAction: {
        '@type': 'SearchAction',
        target: {
          '@type': 'EntryPoint',
          urlTemplate: `${Astro.site}blog?search={search_term_string}`
        },
        'query-input': 'required name=search_term_string'
      }
    })} />

    <script type="application/ld+json" set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'Organization',
      name: 'My Blog',
      url: Astro.site,
      logo: new URL('/favicon.svg', Astro.url),
      sameAs: [
        'https://github.com/fans963/blog'
      ]
    })} />

    <!-- Material Symbols (Google Fonts) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <!-- Maple Mono NF CN Font -->
    <style>
      @font-face {
        font-family: 'Maple Mono NF CN';
        src: url('/fonts/MapleMono-NF-CN-Regular.ttf') format('truetype');
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: 'Maple Mono NF CN';
        src: url('/fonts/MapleMono-NF-CN-Medium.ttf') format('truetype');
        font-weight: 500;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: 'Maple Mono NF CN';
        src: url('/fonts/MapleMono-NF-CN-SemiBold.ttf') format('truetype');
        font-weight: 600;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: 'Maple Mono NF CN';
        src: url('/fonts/MapleMono-NF-CN-Bold.ttf') format('truetype');
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <slot />
    <BackToTop />
  </body>
</html>

<script>
  // Service Worker Registration
  if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then((registration) => {
          console.log('[SW] Service Worker registered:', registration.scope);
        })
        .catch((error) => {
          console.log('[SW] Service Worker registration failed:', error);
        });
    });
  }

  // PWA Install Prompt
  let deferredPrompt = null as any;
  const installButton = document.getElementById('pwa-install-btn');

  window.addEventListener('beforeinstallprompt', (e: any) => {
    e.preventDefault();
    deferredPrompt = e;
    
    if (installButton) {
      installButton.style.display = 'flex';
    }
  });

  window.addEventListener('appinstalled', () => {
    deferredPrompt = null;
    if (installButton) {
      installButton.style.display = 'none';
    }
  });

  if (installButton) {
    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('[PWA] Install outcome:', outcome);
        deferredPrompt = null;
        installButton.style.display = 'none';
      }
    });
  }
</script>

<style is:global>
  /* Apply Material Design 3 color tokens */
  :root {
    --md-sys-color-primary: 0, 102, 204;
    --md-sys-color-on-primary: 255, 255, 255;
    --md-sys-color-primary-container: 209, 227, 255;
    --md-sys-color-on-primary-container: 0, 51, 102;

    --md-sys-color-secondary: 96, 96, 96;
    --md-sys-color-on-secondary: 255, 255, 255;
    --md-sys-color-secondary-container: 224, 224, 224;
    --md-sys-color-on-secondary-container: 32, 32, 32;

    --md-sys-color-tertiary: 116, 76, 28;
    --md-sys-color-on-tertiary: 255, 255, 255;
    --md-sys-color-tertiary-container: 246, 217, 169;
    --md-sys-color-on-tertiary-container: 39, 23, 0;

    --md-sys-color-error: 179, 38, 30;
    --md-sys-color-on-error: 255, 255, 255;
    --md-sys-color-error-container: 255, 217, 213;
    --md-sys-color-on-error-container: 59, 0, 0;

    --md-sys-color-surface: 255, 255, 255;
    --md-sys-color-on-surface: 28, 28, 28;
    --md-sys-color-surface-variant: 227, 227, 227;
    --md-sys-color-on-surface-variant: 96, 96, 96;
    --md-sys-color-surface-tint: 0, 102, 204;

    --md-sys-color-background: 255, 255, 255;
    --md-sys-color-on-background: 28, 28, 28;

    --md-sys-color-outline: 163, 163, 163;
    --md-sys-color-outline-variant: 201, 201, 201;

    --md-sys-color-inverse-surface: 47, 47, 47;
    --md-sys-color-inverse-on-surface: 240, 240, 240;
    --md-sys-color-inverse-primary: 155, 212, 255;
  }

  /* Dark theme tokens */
  @media (prefers-color-scheme: dark) {
    :root {
      --md-sys-color-primary: 155, 212, 255;
      --md-sys-color-on-primary: 0, 51, 102;
      --md-sys-color-primary-container: 0, 77, 153;
      --md-sys-color-on-primary-container: 209, 227, 255;

      --md-sys-color-secondary: 198, 198, 198;
      --md-sys-color-on-secondary: 32, 32, 32;
      --md-sys-color-secondary-container: 64, 64, 64;
      --md-sys-color-on-secondary-container: 224, 224, 224;

      --md-sys-color-tertiary: 233, 192, 127;
      --md-sys-color-on-tertiary: 58, 37, 10;
      --md-sys-color-tertiary-container: 84, 54, 21;
      --md-sys-color-on-tertiary-container: 246, 217, 169;

      --md-sys-color-error: 255, 180, 175;
      --md-sys-color-on-error: 74, 0, 0;
      --md-sys-color-error-container: 120, 30, 29;
      --md-sys-color-on-error-container: 255, 180, 175;

      --md-sys-color-surface: 28, 28, 28;
      --md-sys-color-on-surface: 226, 226, 226;
      --md-sys-color-surface-variant: 64, 64, 64;
      --md-sys-color-on-surface-variant: 198, 198, 198;
      --md-sys-color-surface-tint: 155, 212, 255;

      --md-sys-color-background: 28, 28, 28;
      --md-sys-color-on-background: 226, 226, 226;

      --md-sys-color-outline: 96, 96, 96;
      --md-sys-color-outline-variant: 64, 64, 64;

      --md-sys-color-inverse-surface: 226, 226, 226;
      --md-sys-color-inverse-on-surface: 47, 47, 47;
      --md-sys-color-inverse-primary: 0, 102, 204;
    }
  }

  /* Material Symbols - Filled */
  .material-symbols-filled {
    font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
  }

  /* Material Symbols - Outlined (default) */
  .material-symbols-outlined {
    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
  }
</style>
